env-files: .env
env:
  GLOBAL_VAR_1: "1"
  GLOBAL_VAR_2: "2"
groups:
  global-scope:
    tasks:
      test-var-env-file:
        help: Test env variable defined in the global scope from env-files
        run: |
          import os
          assert str(os.getenv("ENV")) == "dev"

      test-var-env:
        help: Test env variable defined in the global scope in `env` section
        run: |
          import os
          assert str(os.getenv("GLOBAL_VAR_1")) == "1"
          assert str(os.getenv("GLOBAL_VAR_2")) == "2"
  group-scope:
    env-files: .env-group
    env:
      GROUP_VAR_1: "1"
      GROUP_VAR_2: "2"
    tasks:
      test-var-env-file:
        help: Test env variable defined in the global scope from env-files
        run: |
          import os
          assert str(os.getenv("ENV")) == "prod"

      test-var-env:
        help: Test env variable defined in the global scope in `env` section
        run: |
          import os
          assert str(os.getenv("GROUP_VAR_1")) == "1"
          assert str(os.getenv("GROUP_VAR_2")) == "2"

  task-scope:
    tasks:
      test-var-env-file:
        help: Test env variable defined in the global scope from env-files
        env-files: .env-task
        run: |
          import os
          assert str(os.getenv("ENV")) == "test"

      test-var-env:
        help: Test env variable defined in the global scope in `env` section
        env-files: .env-task
        env:
          TARGET_VAR_1: "1"
          TARGET_VAR_2: "2"
          ENV: staging
        run: |
          import os
          assert str(os.getenv("TARGET_VAR_1")) == "1"
          assert str(os.getenv("TARGET_VAR_2")) == "2"
          assert str(os.getenv("ENV")) == "staging"

  rerender-env:
    env-files: .env-group
    env:
      GROUP_VAR_1: "1"
      GROUP_VAR_2: "2"

    tasks:
      dep:
        help: dummy dep
        args:
          my-value:
            help: my_value
            type: string
        run: |
          assert "${{ args.my_value }}" == "${{ env.GROUP_VAR_1 }}" == "1"

      from-global:
        help: Test a rerender from the global scope
        env-files: .env
        hooks:
          pre-run:
            - task: rerender-env.dep
              args:
                my-value: "${{ env.GROUP_VAR_1 }}"
        env:
          MYVAR_1: ${{ env.GLOBAL_VAR_1 }}
          MYVAR_2: ${{ env.GLOBAL_VAR_2 }}
          MYVAR_3: ${{ env.ENV }}
        run: |
          import os
          assert str(os.getenv("MYVAR_1")) == "1"
          assert str(os.getenv("MYVAR_2")) == "2"
          assert str(os.getenv("MYVAR_3")) == "dev"

      from-group:
        help: Test a rerender from the group scope
        env-files: .env-group
        env:
          MYVAR_1: ${{ env.GROUP_VAR_1 }}
          MYVAR_2: ${{ env.GROUP_VAR_2 }}
          MYVAR_3: ${{ env.ENV }}
        run: |
          import os
          assert str(os.getenv("MYVAR_1")) == "1"
          assert str(os.getenv("MYVAR_2")) == "2"
          assert str(os.getenv("MYVAR_3")) == "prod"

      from-task:
        help: Test a rerender from the group scope
        env-files: .env-task
        env:
          MYVAR_1: ${{ env.ENV }}
        run: |
          import os
          assert str(os.getenv("MYVAR_1")) == "test"

  multi-env-files:
    tasks:
      test-global-multi:
        help: Test multiple env-files from global scope are merged correctly
        run: |
          import os
          assert str(os.getenv("ENV")) == "dev"

      test-group-multi:
        help: Test multiple env-files at group scope with override
        env-files:
          - .env
          - .env-group
        run: |
          import os
          assert str(os.getenv("ENV")) == "prod"

      test-task-multi:
        help: Test multiple env-files at task scope with override
        env-files:
          - .env
          - .env-group
          - .env-task
        run: |
          import os
          assert str(os.getenv("ENV")) == "test"

      test-multi-unique-vars:
        help: Test multiple env-files with unique variables from each file
        env-files:
          - .env-multi-1
          - .env-multi-2
        run: |
          import os
          assert str(os.getenv("MULTI_VAR_1")) == "from_file_1"
          assert str(os.getenv("MULTI_VAR_2")) == "from_file_2"

      test-multi-override-order:
        help: Test that later files override earlier files
        env-files:
          - .env-multi-1
          - .env-multi-2
        run: |
          import os
          assert str(os.getenv("SHARED_VAR")) == "from_file_2"
